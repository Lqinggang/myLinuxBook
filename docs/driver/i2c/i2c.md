# I2C 设备

I2C(内置集成电路) 总线通过时钟线SCL、数据线SDA这两根信号线实现设备之间数据的交互, I2C 总线支持多主控模式, 任何能够进行发送和接收的设备够可以成为主设备, 主控能够控制数据的传输和时钟频率, 在任意时刻只能由一个主控

对于I2C, 为了避免总线信号的混乱, 要求各设备连接到总线的输出端**必须是开漏输出或集电极开路输出的结构**

**I2C 总线空闲时, 上拉电阻使 SDA 和 SCL 都保持高电平状态**, 根据开漏输出或集电极开路输出信号的"线与"逻辑, I2C 总线上任意器件输出低电平都会使相应总线上的信号线变低

::: tip 说明
"线与"逻辑指的是两个或两个以上的输出直接互连就可实现"与"的逻辑功能, 只有输出端是开漏(对于CMOS器件)输出或集电极开路(对于TTL器件)输出时才满足此条件
:::

当 SCL 稳定在高电平时, SDA 由高到低(下降沿)产生一个起始位, 由低到高(上升沿)产生一个停止位, 起始位和停止位都是由I2C主设备产生

在选择从设备时, 如果从设备地址采用 7 位地址格式, 则主设备在发起传输过程前， 需先发送 1 字节的地址信息, 前 7 位为设备地址，最后 1 位为读写标志, 之后, 每次传输的数据也是 1 字节, 从 MSB 开始传输, 每个字节传送完后, 在 SCL 的第 9 个上升沿到来前, 接收方应该发出 1  个 ACK位, SCL 上的时钟脉冲由 I2C 主控方发出, 在第 8 个时钟周期之后, 主控方应该释放 SDA(为了从设备返回 ACK)

如下，是 I2C 总线的时序图, 在编写 I2C 驱动的时候将围绕这个时序图展开



I2C 驱动由 3 个部分组成, 即 I2C 核心、I2C 总线驱动以及 I2C 设备驱动

## I2C 核心

I2C 核心提供了 I2C 总线驱动和设备驱动的注册、注销方法，I2C 通信方法上层的与具体适配器无关的代码以及探测设备、检测设备地址的上层代码等

## I2C 总线驱动

I2C 总线驱动是对 I2C 硬件体系结构中适配器端的实现，适配器可由 CPU 控制，甚至可直接集成在 CPU 内部

I2C 总线驱动主要包含了 I2C 适配器数据结构 i2c_adapter、I2C 适配器的 Algorithm 数据结构 i2c_algorithm 和控制 I2C 适配器产生通信信号的函数

## I2C 设备驱动

I2C 设备驱动是对 I2C 硬件体系结构中设备端的实现，设备一般挂接在受 CPU 控制的 I2C 适配器上, 通过 I2C 适配器与 CPU 交换数据

I2C 设备驱动主要包含 i2c_driver 和 i2c_client
